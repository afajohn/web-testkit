# Scripts Directory

This directory contains utility scripts for the Playwright test suite.

## send-to-n8n.js

Sends Playwright test results to n8n webhook endpoint.

### Usage

```bash
# Send test results after running tests
node scripts/send-to-n8n.js

# Or use the npm script
npm run send:n8n
```

### Configuration

The script reads test results from the most recent `test-results.json` file (generated by Playwright's JSON reporter) and sends them to n8n.

**Default webhook URL**: `http://localhost:5678/webhook/playwright-results`  
**Default HTTP method**: `POST` (recommended for large payloads)

**Note**: 
- For GET requests, data is encoded as a query parameter (may fail for large data)
- For POST requests, data is sent in the request body (recommended for test results >30KB)

**Important**: 
- Use `/webhook/` path for **activated workflows** (production mode)
- Use `/webhook-test/` path only for **testing** (works once after clicking "Execute workflow")
- **Make sure your n8n workflow is ACTIVATED** for `/webhook/` to work

**Custom webhook URL**: Set the `N8N_WEBHOOK_URL` environment variable:

```bash
# Windows PowerShell
$env:N8N_WEBHOOK_URL="http://localhost:5678/webhook/playwright-results"
$env:N8N_WEBHOOK_METHOD="POST"  # or "GET" (POST recommended)
node scripts/send-to-n8n.js

# Windows CMD
set N8N_WEBHOOK_URL=http://localhost:5678/webhook/playwright-results
set N8N_WEBHOOK_METHOD=POST
node scripts/send-to-n8n.js

# macOS/Linux
N8N_WEBHOOK_URL=http://localhost:5678/webhook/playwright-results \
N8N_WEBHOOK_METHOD=POST \
node scripts/send-to-n8n.js
```

### Using with URL Testing

To test a specific URL and send results to n8n:

```bash
# Using npm script (note the -- before URL)
npm run test:url:n8n -- https://anewbride.com/

# Or use the script directly
node test-url-n8n.js https://anewbride.com/
```

The `--` is required when passing arguments through npm scripts.

### Requirements

1. **n8n must be running** and accessible at the webhook URL
2. **test-results.json must exist** (generated after running tests)
3. **n8n workflow must be activated** with the webhook configured

### Output Format

The script sends the following payload to n8n:

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "source": "playwright",
  "results": { /* Full Playwright test results JSON */ },
  "summary": {
    "total": 10,
    "passed": 8,
    "failed": 2,
    "skipped": 0,
    "duration": 5000
  }
}
```

### Troubleshooting

**Error: Test results file not found**
- Run tests first: `npm test` or `npm run test:url <URL>`
- Ensure `playwright.config.ts` has JSON reporter configured

**Error: Connection refused / ECONNREFUSED**
- Make sure n8n is running: `n8n`
- Verify webhook URL is correct
- Check that n8n workflow is activated

**Error: Invalid webhook URL**
- Verify URL format: `http://localhost:5678/webhook/playwright-results`
- Check that the path matches your n8n webhook configuration

## test-n8n-connection.js

Test n8n webhook connection with a simple test payload.

### Usage

```bash
node scripts/test-n8n-connection.js

# Or use the npm script
npm run test:n8n-connection
```

### Configuration

**Default webhook URL**: `http://localhost:5678/webhook/playwright-results`  
**Default HTTP method**: `POST`

**Custom webhook URL**: Set the `N8N_WEBHOOK_URL` environment variable (same as send-to-n8n.js)

### What It Does

- Sends a test payload to verify n8n webhook is accessible
- Tests both GET and POST methods
- Provides connection status and response details

### Use Cases

- Verify n8n is running and accessible
- Test webhook configuration before running full tests
- Debug webhook connection issues

## organize-html-report.js

Post-process HTML report to organize it by URL structure. Automatically runs after tests when using `test-url.js` or `run-batch-url-tests.js`.

### Usage

This script runs automatically after tests, but can be run manually:

```bash
# Set URL environment variable first
$env:URL_AUDIT_URL="https://example.com/page.html"
node scripts/organize-html-report.js
```

### What It Does

- Moves HTML report from default `playwright-report/` to URL-based directory
- Creates nested folder structure: `playwright-report/<domain>/<path>/`
- Preserves timestamps by creating timestamped copies
- Merges data directories instead of overwriting

### Features

- Automatic organization based on tested URL
- Handles root URLs: `playwright-report/<domain>/`
- Handles nested paths: `playwright-report/<domain>/path/to/page/`
- Prevents data loss by merging directories

## generate-domain-summary.js

Generate a domain-wide summary report by scanning all JSON report files for a domain.

### Usage

```bash
# Generate summary for default domain (mexicocitydating.com)
node scripts/generate-domain-summary.js

# Generate summary for specific domain
node scripts/generate-domain-summary.js example.com
```

### What It Does

- Scans all JSON report files recursively in `reports/<domain>/`
- Extracts only failures/issues from each report
- Aggregates and deduplicates issues across all pages
- Generates a markdown summary report with:
  - Total pages tested
  - Pages with issues vs pages passed
  - Aggregated SEO failures
  - Unique broken links (deduplicated)
  - Links for review (social media links with warnings)
  - Accessibility violations grouped by rule
  - Pages without GTM

### Output

Generates a timestamped markdown file:
```
reports/<domain>/Report_Summary_<domain>_YYYY-MM-DD_HH-MM.md
```

### Features

- Ignores error-* prefixed files (handles separately)
- Groups accessibility violations by rule and issue
- Deduplicates broken links across pages
- Provides detailed issue listings with URLs

## prepare-github-reports.js

Prepare Playwright HTML reports for GitHub Pages deployment.

### Usage

```bash
# Prepare reports for GitHub Pages (default: gh-pages-reports/)
node scripts/prepare-github-reports.js

# Or use the npm script
npm run prepare:github

# Custom output directory
node scripts/prepare-github-reports.js docs/reports
```

### What It Does

- Scans `playwright-report/` for all HTML reports
- Creates an index page listing all available reports
- Organizes reports in a structure ready for GitHub Pages
- Generates navigation between reports

### Output

Creates a directory (default: `gh-pages-reports/`) with:
- `index.html` - Main index page listing all reports
- All HTML reports organized by URL structure
- Proper relative paths for GitHub Pages

### Use Cases

- Deploy reports to GitHub Pages
- Share reports publicly via URL
- Create a central report dashboard

See `GITHUB_REPORTS.md` for detailed deployment instructions.

## serve-reports.js

Serve Playwright HTML reports via HTTP server for local network access.

### Usage

```bash
# Auto-detect reports, use default port 9323
node scripts/serve-reports.js

# Use custom port
node scripts/serve-reports.js 8080

# Serve specific report
node scripts/serve-reports.js 8080 playwright-report/anewbride.com

# Or use the npm script
npm run serve:reports
```

### What It Does

- Starts an HTTP server serving HTML reports
- Auto-detects available reports in `playwright-report/`
- Provides navigation interface for all reports
- Shows local network IPs for team access

### Features

- Auto-detection of available reports
- Custom port configuration
- Serve specific report or all reports
- Shows network IPs for team access
- Supports all MIME types (HTML, JSON, markdown, videos, etc.)

### Access

Once running, access reports at:
- Local: `http://localhost:9323`
- Network: `http://<your-ip>:9323` (shown in console)

## verify-structure.js

Verify that test-results and playwright-report directories follow the URL-based structure.

### Usage

```bash
node scripts/verify-structure.js

# Or use the npm script
npm run verify:structure
```

### What It Does

- Recursively scans `test-results/` and `playwright-report/` directories
- Displays directory structure as a tree
- Shows all available reports
- Confirms URL-based organization

### Output

Shows:
- Directory tree structure
- All available reports with paths
- Confirmation of URL-based organization

### Use Cases

- Verify report organization after batch testing
- Debug directory structure issues
- Find specific reports

## Additional Documentation

- **GITHUB_REPORTS.md** - Detailed guide for uploading reports to GitHub Pages
- **SHARE_REPORTS.md** - Guide for sharing reports with team members

## Script Dependencies

All scripts use Node.js built-in modules (fs, path, http, https). No external dependencies required beyond Playwright test results.

## Environment Variables

Common environment variables used across scripts:

- `N8N_WEBHOOK_URL` - n8n webhook endpoint URL
- `N8N_WEBHOOK_METHOD` - HTTP method (GET or POST)
- `URL_AUDIT_URL` or `TEST_URL` - URL being tested (used for organization)
- `CI` - Set to 'true' to disable interactive features
